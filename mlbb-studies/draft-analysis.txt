<?php
// Fetch all heroes grouped by role
$api_url = "https://mlbb-stats.ridwaanhall.com/api/hero-position/?role=all&lane=all&size=128&index=1";

$ch = curl_init();
curl_setopt($ch, CURLOPT_URL, $api_url);
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
$response = curl_exec($ch);
curl_close($ch);

$data = json_decode($response, true);
$groupedHeroes = [];

if (isset($data['code']) && $data['code'] == 0) {
    $records = $data['data']['records'];
    foreach ($records as $record) {
        $heroData = $record['data']['hero']['data'] ?? null;
        if (!$heroData) continue;

        $heroName = $heroData['name'] ?? 'Unknown';
        $roles = array_map(fn($r) => $r['data']['sort_title'] ?? 'Unknown', $heroData['sortid'] ?? []);
        $primaryRole = $roles[0] ?? 'Unknown';
        $groupedHeroes[$primaryRole][] = $heroName;
    }
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MLBB Draft Tool with Bans</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <style>
      body {
        background: #181c24;
        font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
      }
      .card {
        box-shadow: 0 0 10px rgba(0,0,0,0.05);
      }
      .select2-container .select2-selection--single {
        height: 38px;
        padding: 6px 12px;
      }
      .form-label {
        font-weight: 600;
      }
  </style>
</head>
<body>

<?php include 'navbar/navbar.php'; ?>

<div class="container py-5">
  <div class="card p-4">
    <h2 class="text-center mb-4 text-primary">MLBB Drafting Analysis Tool</h2>

    <form method="POST">
      <div class="mb-4">
        <label for="pick_order" class="form-label">Pick Order</label>
        <select name="pick_order" id="pick_order" class="form-select" required>
          <option value="" disabled selected>-- Select Pick Order --</option>
          <option value="first">First Pick</option>
          <option value="second">Second Pick</option>
        </select>
      </div>

      <div class="row">
        <!-- Your Team Picks -->
        <div class="col-md-6">
          <h5 class="text-success">Your Team - Picks</h5>
          <?php for ($i = 1; $i <= 5; $i++): ?>
            <div class="mb-3">
              <label class="form-label">Pick <?= $i ?></label>
              <select name="your_team[]" class="form-select select2-hero" required>
                <option value="">Select Hero</option>
                <?php foreach ($groupedHeroes as $role => $heroes): ?>
                  <optgroup label="<?= htmlspecialchars($role) ?>">
                    <?php foreach ($heroes as $hero): ?>
                      <option value="<?= htmlspecialchars($hero) ?>"><?= htmlspecialchars($hero) ?></option>
                    <?php endforeach; ?>
                  </optgroup>
                <?php endforeach; ?>
              </select>
            </div>
          <?php endfor; ?>
        </div>

        <!-- Enemy Team Picks -->
        <div class="col-md-6">
          <h5 class="text-danger">Enemy Team - Picks</h5>
          <?php for ($i = 1; $i <= 5; $i++): ?>
            <div class="mb-3">
              <label class="form-label">Pick <?= $i ?></label>
              <select name="enemy_team[]" class="form-select select2-hero" required>
                <option value="">Select Hero</option>
                <?php foreach ($groupedHeroes as $role => $heroes): ?>
                  <optgroup label="<?= htmlspecialchars($role) ?>">
                    <?php foreach ($heroes as $hero): ?>
                      <option value="<?= htmlspecialchars($hero) ?>"><?= htmlspecialchars($hero) ?></option>
                    <?php endforeach; ?>
                  </optgroup>
                <?php endforeach; ?>
              </select>
            </div>
          <?php endfor; ?>
        </div>
      </div>

      <hr>

      <div class="row mt-4">
        <!-- Your Team Bans -->
        <div class="col-md-6">
          <h5 class="text-success">Your Team - Bans</h5>
          <?php for ($i = 1; $i <= 5; $i++): ?>
            <div class="mb-3">
              <label class="form-label">Ban <?= $i ?></label>
              <select name="your_bans[]" class="form-select select2-hero" required>
                <option value="">Select Hero</option>
                <?php foreach ($groupedHeroes as $role => $heroes): ?>
                  <optgroup label="<?= htmlspecialchars($role) ?>">
                    <?php foreach ($heroes as $hero): ?>
                      <option value="<?= htmlspecialchars($hero) ?>"><?= htmlspecialchars($hero) ?></option>
                    <?php endforeach; ?>
                  </optgroup>
                <?php endforeach; ?>
              </select>
            </div>
          <?php endfor; ?>
        </div>

        <!-- Enemy Team Bans -->
        <div class="col-md-6">
          <h5 class="text-danger">Enemy Team - Bans</h5>
          <?php for ($i = 1; $i <= 5; $i++): ?>
            <div class="mb-3">
              <label class="form-label">Ban <?= $i ?></label>
              <select name="enemy_bans[]" class="form-select select2-hero" required>
                <option value="">Select Hero</option>
                <?php foreach ($groupedHeroes as $role => $heroes): ?>
                  <optgroup label="<?= htmlspecialchars($role) ?>">
                    <?php foreach ($heroes as $hero): ?>
                      <option value="<?= htmlspecialchars($hero) ?>"><?= htmlspecialchars($hero) ?></option>
                    <?php endforeach; ?>
                  </optgroup>
                <?php endforeach; ?>
              </select>
            </div>
          <?php endfor; ?>
        </div>
      </div>

      <div class="text-center mt-4">
        <button type="submit" class="btn btn-primary px-5">Analyze Draft</button>
      </div>
    </form>

    <?php if ($_SERVER["REQUEST_METHOD"] === "POST"): ?>
      <hr>
      <div class="mt-4">
        <h4 class="text-primary">Draft Summary</h4>
        <p><strong>Pick Order:</strong> <?= ucfirst(htmlspecialchars($_POST['pick_order'])) ?></p>
        <p><strong>Your Team Picks:</strong> <?= implode(', ', array_map('htmlspecialchars', $_POST['your_team'])) ?></p>
        <p><strong>Enemy Team Picks:</strong> <?= implode(', ', array_map('htmlspecialchars', $_POST['enemy_team'])) ?></p>
        <p><strong>Your Bans:</strong> <?= implode(', ', array_map('htmlspecialchars', $_POST['your_bans'])) ?></p>
        <p><strong>Enemy Bans:</strong> <?= implode(', ', array_map('htmlspecialchars', $_POST['enemy_bans'])) ?></p>
        <div class="alert alert-info mt-3">ðŸ§  Add counter analysis, ban justification, or synergy scoring here.</div>
      </div>
    <?php endif; ?>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
  $(document).ready(function () {
    $('.select2-hero').select2({
      width: '100%',
      placeholder: "Select a Hero"
    });

    function updateHeroOptions() {
      const selectedHeroes = new Set();

      // Gather all selected values from all dropdowns
      $('.select2-hero').each(function () {
        const val = $(this).val();
        if (val) selectedHeroes.add(val);
      });

      // Re-enable all options first
      $('.select2-hero option').prop('disabled', false);

      // Disable selected options in other selects
      $('.select2-hero').each(function () {
        const $select = $(this);
        const currentVal = $select.val();

        $select.find('option').each(function () {
          const optionVal = $(this).val();
          if (optionVal && selectedHeroes.has(optionVal) && optionVal !== currentVal) {
            $(this).prop('disabled', true);
          }
        });
      });

      // Refresh Select2
      // $('.select2-hero').select2();
    }

    // Trigger on change
    $('.select2-hero').on('change', updateHeroOptions);

    // Initial run
    updateHeroOptions();
  });
</script>
</body>
</html>
